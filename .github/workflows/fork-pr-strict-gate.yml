name: fork-pr-strict-gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  fork-strict-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce stricter policy for fork PRs
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed('Missing pull_request payload.');
              return;
            }

            const isFork = pr.head.repo.full_name !== pr.base.repo.full_name;
            if (!isFork) {
              core.info('Same-repository PR detected. No review required by this gate.');
              return;
            }

            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            // Last state per reviewer is what matters.
            const latestByUser = new Map();
            for (const review of reviews) {
              latestByUser.set(review.user.login, review.state);
            }

            const approvals = [...latestByUser.values()].filter((s) => s === 'APPROVED').length;
            if (approvals < 1) {
              core.setFailed('Fork PR requires at least 1 approving review.');
              return;
            }

            core.info(`Fork PR has ${approvals} approval(s). Gate passed.`);
